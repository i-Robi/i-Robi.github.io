/**
 * @file Animation module.
 * @author SÃ©bastien Robaszkiewicz [hello@robi.me]
 */

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var Edge = require('./Edge');
var Vertex = require('./Vertex');
var World = require('./World');

var PIXEL_RATIO = (function () {
  var context = document.createElement('canvas').getContext('2d');
  var dPR = window.devicePixelRatio || 1;
  var bPR = context.webkitBackingStorePixelRatio || context.mozBackingStorePixelRatio || context.msBackingStorePixelRatio || context.oBackingStorePixelRatio || context.backingStorePixelRatio || 1;

  return dPR / bPR;
})();

function distance(vertex1, vertex2) {
  var dx = vertex1.coordinates.x - vertex2.coordinates.x;
  var dy = vertex1.coordinates.y - vertex2.coordinates.y;

  return dx * dx + dy * dy;
}

function getTime() {
  return window.performance && window.performance.now ? window.performance.now() / 1000 : new Date().getTime() / 1000;
}

/**
 * @class Filter
 * @description Calculates the derivative and applies a low-pass filter.
 */

var Filter = (function () {
  function Filter(timeConstant) {
    _classCallCheck(this, Filter);

    this._dX;
    this._dXFiltered;
    this._previousX;
    this._previousDXFiltered;
    this._previousTimestamp;
    this._timeConstant = timeConstant;
  }

  /**
   * @class Animation
   * @extends World
   * @description Calculates and renders the canvas animation.
   */

  _createClass(Filter, [{
    key: '_decay',
    value: function _decay(dt) {
      return Math.exp(-2 * Math.PI * dt / this._timeConstant);
    }
  }, {
    key: 'input',
    value: function input(x) {
      var now = getTime();
      var k = undefined;

      if (this._previousTimestamp && this._previousX) {
        var dt = now - this._previousTimestamp;
        k = this._decay(dt);
        this._dX = (x - this._previousX) / dt;
      }

      this._previousTimestamp = now;
      this._previousX = x;

      if (this._dX) {
        if (this._previousDXFiltered) this._dXFiltered = k * this._previousDXFiltered + (1 - k) * this._dX;else this._dXFiltered = this._dX;

        this._previousDXFiltered = this._dXFiltered;

        return this._dXFiltered;
      }

      return;
    }
  }]);

  return Filter;
})();

var Animation = (function (_World) {
  _inherits(Animation, _World);

  function Animation() {
    _classCallCheck(this, Animation);

    _get(Object.getPrototypeOf(Animation.prototype), 'constructor', this).call(this);

    this._canvas = document.querySelector('#scene');
    this._canvasHeight;
    this._canvasWidth;
    this._edges = [];
    this._elapsedTime = 0;
    this._filter;
    this._vertices = [];
    this._verticesNum;
    this._windowWidth;
    this._windowHeight;

    this.config;
    this.ctx = this._canvas.getContext('2d');

    this._updateCanvasSize = this._updateCanvasSize.bind(this);
  }

  _createClass(Animation, [{
    key: 'render',
    value: function render(dt) {
      this.ctx.clearRect(0, 0, this._canvasWidth, this._canvasHeight);

      for (var i = 0; i < this._vertices.length; i++) {
        this._vertices[i].draw(this.ctx, dt);
      }for (var i = 0; i < this._edges.length; i++) {
        this._edges[i].draw(this.ctx, dt);
      }
    }
  }, {
    key: 'update',
    value: function update(dt) {
      this._edges = [];

      for (var i = 0; i < this._vertices.length; i++) {
        // Update the vertex
        var vertex1 = this._vertices[i];
        this._vertices[i].update(this._elapsedTime, dt, this._canvasWidth, this._canvasHeight);

        // Update the edges array
        for (var j = i; j > 0; j--) {
          var vertex2 = this._vertices[j];
          var dist = distance(vertex1, vertex2);
          var minDistance = this.config.minDistance * this.config.minDistance;

          if (dist < minDistance) {
            var edge = new Edge(vertex1, vertex2, dist, minDistance);
            this._edges.push(edge);
          }
        }
      }

      this._elapsedTime += dt;
    }
  }, {
    key: '_updateCanvasSize',
    value: function _updateCanvasSize() {
      this._windowWidth = parseInt(window.innerWidth, 10);
      this._windowHeight = parseInt(window.innerHeight, 10);
      this._canvasWidth = this._windowWidth * PIXEL_RATIO;
      this._canvasHeight = this._windowHeight * PIXEL_RATIO;

      this._canvas.width = this._canvasWidth;
      this._canvas.height = this._canvasHeight;
      this._canvas.style.width = this._windowWidth + "px";
      this._canvas.style.height = this._windowHeight + "px";
      this._canvas.getContext("2d").setTransform(PIXEL_RATIO, 0, 0, PIXEL_RATIO, 0, 0);

      this._vertices = [];
      this._verticesNum = Math.round(this._canvasWidth * this._canvasHeight * this.config.vertexDensity * 0.00003);

      for (var i = 0; i < this._verticesNum; ++i) {
        this._vertices.push(new Vertex(this.config));
      }
    }
  }, {
    key: 'start',
    value: function start(worldConfig, gameloopConfig) {
      _get(Object.getPrototypeOf(Animation.prototype), 'start', this).call(this, worldConfig, gameloopConfig);

      this._updateCanvasSize();
      this._betaFilter = new Filter(this.config.filterTimeConstant);
      this._gammaFilter = new Filter(this.config.filterTimeConstant);
      window.addEventListener('resize', this._updateCanvasSize);
    }
  }, {
    key: 'onOrientation',
    value: function onOrientation(beta, gamma) {
      var dBetaFiltered = this._betaFilter.input(beta);
      var dGammaFiltered = this._gammaFilter.input(gamma);

      if (dBetaFiltered && dGammaFiltered) {
        for (var i = 0; i < this._vertices.length; i++) {
          this._vertices[i].onOrientation(dBetaFiltered, dGammaFiltered);
        }
      }
    }
  }]);

  return Animation;
})(World);

module.exports = new Animation();
//# sourceMappingURL=data:application/json;base64,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SUFBSSxFQUFFLEtBQUssRUFBRTtBQUN6QixVQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNuRCxVQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFdEQsVUFBSSxhQUFhLElBQUksY0FBYyxFQUFFO0FBQ25DLGFBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUU7QUFDNUMsY0FBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1NBQUE7T0FDbEU7S0FDRjs7O1NBbEdHLFNBQVM7R0FBUyxLQUFLOztBQXFHN0IsTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDIiwiZmlsZSI6InNyYy9qcy9hbmltYXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIEFuaW1hdGlvbiBtb2R1bGUuXG4gKiBAYXV0aG9yIFPDqWJhc3RpZW4gUm9iYXN6a2lld2ljeiBbaGVsbG9Acm9iaS5tZV1cbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEVkZ2UgPSByZXF1aXJlKCcuL0VkZ2UnKTtcbmNvbnN0IFZlcnRleCA9IHJlcXVpcmUoJy4vVmVydGV4Jyk7XG5jb25zdCBXb3JsZCA9IHJlcXVpcmUoJy4vV29ybGQnKTtcblxuY29uc3QgUElYRUxfUkFUSU8gPSAoZnVuY3Rpb24oKSB7XG4gIGNvbnN0IGNvbnRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKS5nZXRDb250ZXh0KCcyZCcpO1xuICBjb25zdCBkUFIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxO1xuICBjb25zdCBiUFIgPSBjb250ZXh0LndlYmtpdEJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHxcbiAgICBjb250ZXh0Lm1vekJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHxcbiAgICBjb250ZXh0Lm1zQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fFxuICAgIGNvbnRleHQub0JhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHxcbiAgICBjb250ZXh0LmJhY2tpbmdTdG9yZVBpeGVsUmF0aW8gfHwgMTtcblxuICByZXR1cm4gZFBSIC8gYlBSO1xufSkoKTtcblxuZnVuY3Rpb24gZGlzdGFuY2UodmVydGV4MSwgdmVydGV4Mikge1xuICBsZXQgZHggPSB2ZXJ0ZXgxLmNvb3JkaW5hdGVzLnggLSB2ZXJ0ZXgyLmNvb3JkaW5hdGVzLng7XG4gIGxldCBkeSA9IHZlcnRleDEuY29vcmRpbmF0ZXMueSAtIHZlcnRleDIuY29vcmRpbmF0ZXMueTtcblxuICByZXR1cm4gZHggKiBkeCArIGR5ICogZHk7XG59XG5cbmZ1bmN0aW9uIGdldFRpbWUoKSB7XG4gIHJldHVybiAod2luZG93LnBlcmZvcm1hbmNlICYmIHdpbmRvdy5wZXJmb3JtYW5jZS5ub3cpID9cbiAgICB3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgLyAxMDAwIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwO1xufVxuXG4vKipcbiAqIEBjbGFzcyBGaWx0ZXJcbiAqIEBkZXNjcmlwdGlvbiBDYWxjdWxhdGVzIHRoZSBkZXJpdmF0aXZlIGFuZCBhcHBsaWVzIGEgbG93LXBhc3MgZmlsdGVyLlxuICovXG5jbGFzcyBGaWx0ZXIge1xuICBjb25zdHJ1Y3Rvcih0aW1lQ29uc3RhbnQpIHtcbiAgICB0aGlzLl9kWDtcbiAgICB0aGlzLl9kWEZpbHRlcmVkO1xuICAgIHRoaXMuX3ByZXZpb3VzWDtcbiAgICB0aGlzLl9wcmV2aW91c0RYRmlsdGVyZWQ7XG4gICAgdGhpcy5fcHJldmlvdXNUaW1lc3RhbXA7XG4gICAgdGhpcy5fdGltZUNvbnN0YW50ID0gdGltZUNvbnN0YW50O1xuICB9XG5cbiAgX2RlY2F5KGR0KSB7XG4gICAgcmV0dXJuIE1hdGguZXhwKC0yICogTWF0aC5QSSAqIGR0IC8gdGhpcy5fdGltZUNvbnN0YW50KTtcbiAgfVxuXG4gIGlucHV0KHgpIHtcbiAgICBjb25zdCBub3cgPSBnZXRUaW1lKCk7XG4gICAgbGV0IGs7XG5cbiAgICBpZiAodGhpcy5fcHJldmlvdXNUaW1lc3RhbXAgJiYgdGhpcy5fcHJldmlvdXNYKcKge1xuICAgICAgY29uc3QgZHQgPSBub3cgLSB0aGlzLl9wcmV2aW91c1RpbWVzdGFtcDtcbiAgICAgIGsgPSB0aGlzLl9kZWNheShkdCk7XG4gICAgICB0aGlzLl9kWCA9ICh4IC0gdGhpcy5fcHJldmlvdXNYKSAvIGR0O1xuICAgIH1cblxuICAgIHRoaXMuX3ByZXZpb3VzVGltZXN0YW1wID0gbm93O1xuICAgIHRoaXMuX3ByZXZpb3VzWCA9IHg7XG5cbiAgICBpZiAodGhpcy5fZFgpIHtcbiAgICAgIGlmICh0aGlzLl9wcmV2aW91c0RYRmlsdGVyZWQpXG4gICAgICAgIHRoaXMuX2RYRmlsdGVyZWQgPSBrICogdGhpcy5fcHJldmlvdXNEWEZpbHRlcmVkICsgKDEgLSBrKSAqIHRoaXMuX2RYO1xuICAgICAgZWxzZVxuICAgICAgICB0aGlzLl9kWEZpbHRlcmVkID0gdGhpcy5fZFg7XG5cbiAgICAgIHRoaXMuX3ByZXZpb3VzRFhGaWx0ZXJlZCA9IHRoaXMuX2RYRmlsdGVyZWQ7XG5cbiAgICAgIHJldHVybiB0aGlzLl9kWEZpbHRlcmVkO1xuICAgIH1cblxuICAgIHJldHVybjtcbiAgfVxufVxuXG4vKipcbiAqIEBjbGFzcyBBbmltYXRpb25cbiAqIEBleHRlbmRzIFdvcmxkXG4gKiBAZGVzY3JpcHRpb24gQ2FsY3VsYXRlcyBhbmQgcmVuZGVycyB0aGUgY2FudmFzIGFuaW1hdGlvbi5cbiAqL1xuY2xhc3MgQW5pbWF0aW9uIGV4dGVuZHMgV29ybGQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5fY2FudmFzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3NjZW5lJyk7XG4gICAgdGhpcy5fY2FudmFzSGVpZ2h0O1xuICAgIHRoaXMuX2NhbnZhc1dpZHRoO1xuICAgIHRoaXMuX2VkZ2VzID0gW107XG4gICAgdGhpcy5fZWxhcHNlZFRpbWUgPSAwO1xuICAgIHRoaXMuX2ZpbHRlcjtcbiAgICB0aGlzLl92ZXJ0aWNlcyA9IFtdO1xuICAgIHRoaXMuX3ZlcnRpY2VzTnVtO1xuICAgIHRoaXMuX3dpbmRvd1dpZHRoO1xuICAgIHRoaXMuX3dpbmRvd0hlaWdodDtcblxuICAgIHRoaXMuY29uZmlnO1xuICAgIHRoaXMuY3R4ID0gdGhpcy5fY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG5cbiAgICB0aGlzLl91cGRhdGVDYW52YXNTaXplID0gdGhpcy5fdXBkYXRlQ2FudmFzU2l6ZS5iaW5kKHRoaXMpO1xuICB9XG5cbiAgcmVuZGVyKGR0KSB7XG4gICAgdGhpcy5jdHguY2xlYXJSZWN0KDAsIDAsIHRoaXMuX2NhbnZhc1dpZHRoLCB0aGlzLl9jYW52YXNIZWlnaHQpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl92ZXJ0aWNlcy5sZW5ndGg7IGkrKylcbiAgICAgIHRoaXMuX3ZlcnRpY2VzW2ldLmRyYXcodGhpcy5jdHgsIGR0KTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fZWRnZXMubGVuZ3RoOyBpKyspXG4gICAgICB0aGlzLl9lZGdlc1tpXS5kcmF3KHRoaXMuY3R4LCBkdCk7XG4gIH1cblxuICB1cGRhdGUoZHQpIHtcbiAgICB0aGlzLl9lZGdlcyA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl92ZXJ0aWNlcy5sZW5ndGg7IGkrKykge1xuICAgICAgLy8gVXBkYXRlIHRoZSB2ZXJ0ZXhcbiAgICAgIGxldCB2ZXJ0ZXgxID0gdGhpcy5fdmVydGljZXNbaV07XG4gICAgICB0aGlzLl92ZXJ0aWNlc1tpXS51cGRhdGUoXG4gICAgICAgIHRoaXMuX2VsYXBzZWRUaW1lLFxuICAgICAgICBkdCxcbiAgICAgICAgdGhpcy5fY2FudmFzV2lkdGgsXG4gICAgICAgIHRoaXMuX2NhbnZhc0hlaWdodFxuICAgICAgKTtcblxuICAgICAgLy8gVXBkYXRlIHRoZSBlZGdlcyBhcnJheVxuICAgICAgZm9yIChsZXQgaiA9IGk7IGogPiAwOyBqLS0pIHtcbiAgICAgICAgbGV0IHZlcnRleDIgPSB0aGlzLl92ZXJ0aWNlc1tqXTtcbiAgICAgICAgbGV0IGRpc3QgPSBkaXN0YW5jZSh2ZXJ0ZXgxLCB2ZXJ0ZXgyKTtcbiAgICAgICAgY29uc3QgbWluRGlzdGFuY2UgPSB0aGlzLmNvbmZpZy5taW5EaXN0YW5jZSAqIHRoaXMuY29uZmlnLm1pbkRpc3RhbmNlO1xuXG4gICAgICAgIGlmIChkaXN0IDwgbWluRGlzdGFuY2UpIHtcbiAgICAgICAgICBsZXQgZWRnZSA9IG5ldyBFZGdlKHZlcnRleDEsIHZlcnRleDIsIGRpc3QsIG1pbkRpc3RhbmNlKTtcbiAgICAgICAgICB0aGlzLl9lZGdlcy5wdXNoKGVkZ2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5fZWxhcHNlZFRpbWUgKz0gZHQ7XG4gIH1cblxuICBfdXBkYXRlQ2FudmFzU2l6ZSgpIHtcbiAgICB0aGlzLl93aW5kb3dXaWR0aCA9IHBhcnNlSW50KHdpbmRvdy5pbm5lcldpZHRoLCAxMCk7XG4gICAgdGhpcy5fd2luZG93SGVpZ2h0ID0gcGFyc2VJbnQod2luZG93LmlubmVySGVpZ2h0LCAxMCk7XG4gICAgdGhpcy5fY2FudmFzV2lkdGggPSB0aGlzLl93aW5kb3dXaWR0aCAqIFBJWEVMX1JBVElPO1xuICAgIHRoaXMuX2NhbnZhc0hlaWdodCA9IHRoaXMuX3dpbmRvd0hlaWdodCAqIFBJWEVMX1JBVElPO1xuXG4gICAgdGhpcy5fY2FudmFzLndpZHRoID0gdGhpcy5fY2FudmFzV2lkdGg7XG4gICAgdGhpcy5fY2FudmFzLmhlaWdodCA9IHRoaXMuX2NhbnZhc0hlaWdodDtcbiAgICB0aGlzLl9jYW52YXMuc3R5bGUud2lkdGggPSB0aGlzLl93aW5kb3dXaWR0aCArIFwicHhcIjtcbiAgICB0aGlzLl9jYW52YXMuc3R5bGUuaGVpZ2h0ID0gdGhpcy5fd2luZG93SGVpZ2h0ICsgXCJweFwiO1xuICAgIHRoaXMuX2NhbnZhcy5nZXRDb250ZXh0KFwiMmRcIilcbiAgICAgIC5zZXRUcmFuc2Zvcm0oUElYRUxfUkFUSU8sIDAsIDAsIFBJWEVMX1JBVElPLCAwLCAwKTtcblxuICAgIHRoaXMuX3ZlcnRpY2VzID0gW107XG4gICAgdGhpcy5fdmVydGljZXNOdW0gPSBNYXRoLnJvdW5kKHRoaXMuX2NhbnZhc1dpZHRoICogdGhpcy5fY2FudmFzSGVpZ2h0XG4gICAgICAqIHRoaXMuY29uZmlnLnZlcnRleERlbnNpdHkgKiAwLjAwMDAzKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fdmVydGljZXNOdW07ICsraSlcbiAgICAgIHRoaXMuX3ZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCh0aGlzLmNvbmZpZykpO1xuICB9XG5cbiAgc3RhcnQod29ybGRDb25maWcsIGdhbWVsb29wQ29uZmlnKSB7XG4gICAgc3VwZXIuc3RhcnQod29ybGRDb25maWcsIGdhbWVsb29wQ29uZmlnKTtcblxuICAgIHRoaXMuX3VwZGF0ZUNhbnZhc1NpemUoKTtcbiAgICB0aGlzLl9iZXRhRmlsdGVyID0gbmV3IEZpbHRlcih0aGlzLmNvbmZpZy5maWx0ZXJUaW1lQ29uc3RhbnQpO1xuICAgIHRoaXMuX2dhbW1hRmlsdGVyID0gbmV3IEZpbHRlcih0aGlzLmNvbmZpZy5maWx0ZXJUaW1lQ29uc3RhbnQpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLl91cGRhdGVDYW52YXNTaXplKTtcbiAgfVxuXG4gIG9uT3JpZW50YXRpb24oYmV0YSwgZ2FtbWEpIHtcbiAgICBjb25zdCBkQmV0YUZpbHRlcmVkID0gdGhpcy5fYmV0YUZpbHRlci5pbnB1dChiZXRhKTtcbiAgICBjb25zdCBkR2FtbWFGaWx0ZXJlZCA9IHRoaXMuX2dhbW1hRmlsdGVyLmlucHV0KGdhbW1hKTtcblxuICAgIGlmIChkQmV0YUZpbHRlcmVkICYmIGRHYW1tYUZpbHRlcmVkKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3ZlcnRpY2VzLmxlbmd0aDsgaSsrKVxuICAgICAgICB0aGlzLl92ZXJ0aWNlc1tpXS5vbk9yaWVudGF0aW9uKGRCZXRhRmlsdGVyZWQsIGRHYW1tYUZpbHRlcmVkKTtcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBuZXcgQW5pbWF0aW9uKCk7XG4iXX0=