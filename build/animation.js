'use strict';

var loop = require('./loop');
var Vertex = require('./Vertex');
var Edge = require('./Edge');

// Canvas parameters
var canvasWidth;
var canvasHeight;
var windowWidth;
var windowHeight;
var canvas;
var ctx;

// Game loop options
var options = {
  ctx: ctx,
  buffers: [],
  update: update,
  render: render,
  fps: 60
  // gui: gui.model
};

var edges = [];
var elapsedTime = 0;

// Game loop main functions
function update(dt) {
  edges = [];

  for (var i = 0; i < vertices.length; i++) {
    var vertex1 = vertices[i];
    vertices[i].update(elapsedTime, dt, canvasWidth, canvasHeight);

    for (var j = i; j > 0; j--) {
      var vertex2 = vertices[j];
      var dist = distance(vertex1, vertex2);

      if (dist < minDist) edges.push(new Edge(vertex1, vertex2, dist, minDist));
    }
  }

  elapsedTime += dt;
}

function render(dt) {
  ctx.clearRect(0, 0, canvasWidth, canvasHeight);

  for (var i = 0; i < vertices.length; i++) {
    vertices[i].draw(ctx, dt);
  }for (var i = 0; i < edges.length; i++) {
    edges[i].draw(ctx, dt);
  }
}

function start() {
  windowWidth = parseInt(window.innerWidth, 10);
  windowHeight = parseInt(window.innerHeight, 10);

  canvas = document.querySelector('#scene');
  ctx = canvas.getContext('2d');

  updateCanvasSize();
  window.addEventListener('resize', updateCanvasSize);

  loop.run(options);
}

// Animation
var minDist = 20000; // square distance
var verticesNum;
var vertices = [];

var PIXEL_RATIO = (function () {
  var context = document.createElement("canvas").getContext("2d"),
      dpr = window.devicePixelRatio || 1,
      bsr = context.webkitBackingStorePixelRatio || context.mozBackingStorePixelRatio || context.msBackingStorePixelRatio || context.oBackingStorePixelRatio || context.backingStorePixelRatio || 1;

  return dpr / bsr;
})();

function updateCanvasSize() {
  windowWidth = parseInt(window.innerWidth, 10);
  windowHeight = parseInt(window.innerHeight, 10);
  canvasWidth = windowWidth * PIXEL_RATIO;
  canvasHeight = windowHeight * PIXEL_RATIO;

  canvas.width = canvasWidth;
  canvas.height = canvasHeight;
  canvas.style.width = windowWidth + "px";
  canvas.style.height = windowHeight + "px";
  canvas.getContext("2d").setTransform(PIXEL_RATIO, 0, 0, PIXEL_RATIO, 0, 0);

  vertices = [];
  verticesNum = Math.round(canvasWidth * canvasHeight / 12000);

  for (var i = 0; i < verticesNum; i++) {
    vertices.push(new Vertex({
      canvasMargin: 0.1,
      velocityFactor: 7,
      minRadius: 4,
      radiusVariance: 6,
      minFadeinDuration: 3,
      fadeinDurationVariance: 2
    }));
  }
}

function distance(vertex1, vertex2) {
  var dx = vertex1.coordinates.x - vertex2.coordinates.x;
  var dy = vertex1.coordinates.y - vertex2.coordinates.y;

  return dx * dx + dy * dy;
}

function drawEdge(vertex1, vertex2, dist) {
  ctx.beginPath();
  ctx.strokeStyle = "rgba(0, 0, 0, " + (1.2 - dist / minDist) * Math.max(vertex1.opacity, vertex2.opacity) + ")";
  ctx.moveTo(vertex1.coordinates.x, vertex1.coordinates.y);
  ctx.lineTo(vertex2.coordinates.x, vertex2.coordinates.y);
  ctx.stroke();
  ctx.closePath();
}

function onOrientation(beta, gamma) {
  var now = timestamp();
  var k = 0.8;

  if (previousTimestamp && previousBeta && previousGamma) {
    var dt = now - previousTimestamp;
    dBeta = (beta - previousBeta) / dt;
    dGamma = (gamma - previousGamma) / dt;
  }

  previousTimestamp = now;
  previousBeta = beta;
  previousGamma = gamma;

  if (dBeta && dGamma) {
    if (previousDBetaFiltered && previousDGammaFiltered) {
      dBetaFiltered = k * previousDBetaFiltered + (1 - k) * dBeta;
      dGammaFiltered = k * previousDGammaFiltered + (1 - k) * dGamma;
    } else {
      dBetaFiltered = dBeta;
      dGammaFiltered = dGamma;
    }

    previousDBetaFiltered = dBetaFiltered;
    previousDGammaFiltered = dGammaFiltered;

    for (var i = 0; i < vertices.length; i++) {
      vertices[i].onOrientation(dBetaFiltered, dGammaFiltered);
    }
  }
}

function timestamp() {
  return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
}

var previousTimestamp;
var previousBeta;
var previousGamma;
var dBeta;
var dGamma;
var dBetaFiltered;
var dGammaFiltered;
var previousDBetaFiltered;
var previousDGammaFiltered;

module.exports = {
  start: start,
  onOrientation: onOrientation
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9qcy9hbmltYXRpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUViLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDbkMsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDOzs7QUFHL0IsSUFBSSxXQUFXLENBQUM7QUFDaEIsSUFBSSxZQUFZLENBQUM7QUFDakIsSUFBSSxXQUFXLENBQUM7QUFDaEIsSUFBSSxZQUFZLENBQUM7QUFDakIsSUFBSSxNQUFNLENBQUM7QUFDWCxJQUFJLEdBQUcsQ0FBQzs7O0FBR1IsSUFBSSxPQUFPLEdBQUc7QUFDWixLQUFHLEVBQUUsR0FBRztBQUNSLFNBQU8sRUFBRSxFQUFFO0FBQ1gsUUFBTSxFQUFFLE1BQU07QUFDZCxRQUFNLEVBQUUsTUFBTTtBQUNkLEtBQUcsRUFBRSxFQUFFOztDQUVSLENBQUM7O0FBRUYsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBQ2YsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDOzs7QUFHcEIsU0FBUyxNQUFNLENBQUMsRUFBRSxFQUFFO0FBQ2xCLE9BQUssR0FBRyxFQUFFLENBQUM7O0FBRVgsT0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDeEMsUUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFCLFlBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7O0FBRS9ELFNBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDMUIsVUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFCLFVBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7O0FBRXRDLFVBQUksSUFBSSxHQUFHLE9BQU8sRUFDaEIsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0tBQ3pEO0dBQ0Y7O0FBRUQsYUFBVyxJQUFJLEVBQUUsQ0FBQztDQUNuQjs7QUFFRCxTQUFTLE1BQU0sQ0FBQyxFQUFFLEVBQUU7QUFDbEIsS0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQzs7QUFFL0MsT0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFO0FBQ3RDLFlBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0dBQUEsQUFFNUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFO0FBQ25DLFNBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0dBQUE7Q0FDMUI7O0FBRUQsU0FBUyxLQUFLLEdBQUc7QUFDZixhQUFXLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDOUMsY0FBWSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDOztBQUVoRCxRQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQyxLQUFHLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFOUIsa0JBQWdCLEVBQUUsQ0FBQTtBQUNsQixRQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLGdCQUFnQixDQUFDLENBQUM7O0FBRXBELE1BQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7Q0FDbkI7OztBQUdELElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztBQUNwQixJQUFJLFdBQVcsQ0FBQztBQUNoQixJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7O0FBRWxCLElBQUksV0FBVyxHQUFHLENBQUMsWUFBVztBQUM1QixNQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7TUFDN0QsR0FBRyxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDO01BQ2xDLEdBQUcsR0FBRyxPQUFPLENBQUMsNEJBQTRCLElBQzFDLE9BQU8sQ0FBQyx5QkFBeUIsSUFDakMsT0FBTyxDQUFDLHdCQUF3QixJQUNoQyxPQUFPLENBQUMsdUJBQXVCLElBQy9CLE9BQU8sQ0FBQyxzQkFBc0IsSUFBSSxDQUFDLENBQUM7O0FBRXRDLFNBQU8sR0FBRyxHQUFHLEdBQUcsQ0FBQztDQUNsQixDQUFBLEVBQUcsQ0FBQzs7QUFFTCxTQUFTLGdCQUFnQixHQUFHO0FBQzFCLGFBQVcsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUM5QyxjQUFZLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDaEQsYUFBVyxHQUFHLFdBQVcsR0FBRyxXQUFXLENBQUM7QUFDeEMsY0FBWSxHQUFHLFlBQVksR0FBRyxXQUFXLENBQUM7O0FBRTFDLFFBQU0sQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDO0FBQzNCLFFBQU0sQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDO0FBQzdCLFFBQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLFdBQVcsR0FBRyxJQUFJLENBQUM7QUFDeEMsUUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsWUFBWSxHQUFHLElBQUksQ0FBQztBQUMxQyxRQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDOztBQUUzRSxVQUFRLEdBQUcsRUFBRSxDQUFDO0FBQ2QsYUFBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxHQUFHLFlBQVksR0FBRyxLQUFLLENBQUMsQ0FBQzs7QUFFN0QsT0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFdBQVcsRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUNwQyxZQUFRLENBQUMsSUFBSSxDQUFDLElBQUksTUFBTSxDQUFDO0FBQ3ZCLGtCQUFZLEVBQUUsR0FBRztBQUNqQixvQkFBYyxFQUFFLENBQUM7QUFDakIsZUFBUyxFQUFFLENBQUM7QUFDWixvQkFBYyxFQUFFLENBQUM7QUFDakIsdUJBQWlCLEVBQUUsQ0FBQztBQUNwQiw0QkFBc0IsRUFBRSxDQUFDO0tBQzFCLENBQUMsQ0FBQyxDQUFDO0dBQ0w7Q0FDRjs7QUFFRCxTQUFTLFFBQVEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFO0FBQ2xDLE1BQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0FBQ3ZELE1BQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDOztBQUV2RCxTQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztDQUMxQjs7QUFFRCxTQUFTLFFBQVEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRTtBQUN4QyxLQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDaEIsS0FBRyxDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLEdBQUcsT0FBTyxDQUFBLEdBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDL0csS0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pELEtBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN6RCxLQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDYixLQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7Q0FDakI7O0FBRUQsU0FBUyxhQUFhLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRTtBQUNsQyxNQUFJLEdBQUcsR0FBRyxTQUFTLEVBQUUsQ0FBQztBQUN0QixNQUFJLENBQUMsR0FBRyxHQUFHLENBQUM7O0FBRVosTUFBSSxpQkFBaUIsSUFBSSxZQUFZLElBQUksYUFBYSxFQUFHO0FBQ3ZELFFBQUksRUFBRSxHQUFHLEdBQUcsR0FBRyxpQkFBaUIsQ0FBQztBQUNqQyxTQUFLLEdBQUcsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFBLEdBQUksRUFBRSxDQUFDO0FBQ25DLFVBQU0sR0FBRyxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUEsR0FBSSxFQUFFLENBQUM7R0FDdkM7O0FBRUQsbUJBQWlCLEdBQUcsR0FBRyxDQUFDO0FBQ3hCLGNBQVksR0FBRyxJQUFJLENBQUM7QUFDcEIsZUFBYSxHQUFHLEtBQUssQ0FBQzs7QUFFdEIsTUFBSSxLQUFLLElBQUksTUFBTSxFQUFFO0FBQ25CLFFBQUkscUJBQXFCLElBQUksc0JBQXNCLEVBQUU7QUFDbkQsbUJBQWEsR0FBRyxDQUFDLEdBQUcscUJBQXFCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBLEdBQUksS0FBSyxDQUFDO0FBQzVELG9CQUFjLEdBQUcsQ0FBQyxHQUFHLHNCQUFzQixHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQSxHQUFJLE1BQU0sQ0FBQztLQUNoRSxNQUFNO0FBQ0wsbUJBQWEsR0FBRyxLQUFLLENBQUM7QUFDdEIsb0JBQWMsR0FBRyxNQUFNLENBQUM7S0FDekI7O0FBRUQseUJBQXFCLEdBQUcsYUFBYSxDQUFDO0FBQ3RDLDBCQUFzQixHQUFHLGNBQWMsQ0FBQzs7QUFFeEMsU0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFO0FBQ3RDLGNBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0tBQUE7R0FDNUQ7Q0FDRjs7QUFFRCxTQUFTLFNBQVMsR0FBRztBQUNuQixTQUFPLE1BQU0sQ0FBQyxXQUFXLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO0NBQ3ZHOztBQUVELElBQUksaUJBQWlCLENBQUM7QUFDdEIsSUFBSSxZQUFZLENBQUM7QUFDakIsSUFBSSxhQUFhLENBQUM7QUFDbEIsSUFBSSxLQUFLLENBQUM7QUFDVixJQUFJLE1BQU0sQ0FBQztBQUNYLElBQUksYUFBYSxDQUFDO0FBQ2xCLElBQUksY0FBYyxDQUFDO0FBQ25CLElBQUkscUJBQXFCLENBQUM7QUFDMUIsSUFBSSxzQkFBc0IsQ0FBQzs7QUFFM0IsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLE9BQUssRUFBRSxLQUFLO0FBQ1osZUFBYSxFQUFFLGFBQWE7Q0FDN0IsQ0FBQyIsImZpbGUiOiJzcmMvanMvYW5pbWF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBsb29wID0gcmVxdWlyZSgnLi9sb29wJyk7XG5jb25zdCBWZXJ0ZXggPSByZXF1aXJlKCcuL1ZlcnRleCcpO1xuY29uc3QgRWRnZSA9IHJlcXVpcmUoJy4vRWRnZScpO1xuXG4vLyBDYW52YXMgcGFyYW1ldGVyc1xudmFyIGNhbnZhc1dpZHRoO1xudmFyIGNhbnZhc0hlaWdodDtcbnZhciB3aW5kb3dXaWR0aDtcbnZhciB3aW5kb3dIZWlnaHQ7XG52YXIgY2FudmFzO1xudmFyIGN0eDtcblxuLy8gR2FtZSBsb29wIG9wdGlvbnNcbnZhciBvcHRpb25zID0ge1xuICBjdHg6IGN0eCxcbiAgYnVmZmVyczogW10sXG4gIHVwZGF0ZTogdXBkYXRlLFxuICByZW5kZXI6IHJlbmRlcixcbiAgZnBzOiA2MFxuICAgIC8vIGd1aTogZ3VpLm1vZGVsXG59O1xuXG52YXIgZWRnZXMgPSBbXTtcbnZhciBlbGFwc2VkVGltZSA9IDA7XG5cbi8vIEdhbWUgbG9vcCBtYWluIGZ1bmN0aW9uc1xuZnVuY3Rpb24gdXBkYXRlKGR0KSB7XG4gIGVkZ2VzID0gW107XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJ0aWNlcy5sZW5ndGg7IGkrKykge1xuICAgIGxldCB2ZXJ0ZXgxID0gdmVydGljZXNbaV07XG4gICAgdmVydGljZXNbaV0udXBkYXRlKGVsYXBzZWRUaW1lLCBkdCwgY2FudmFzV2lkdGgsIGNhbnZhc0hlaWdodCk7XG5cbiAgICBmb3IgKGxldCBqID0gaTsgaiA+IDA7IGotLSkge1xuICAgICAgbGV0IHZlcnRleDIgPSB2ZXJ0aWNlc1tqXTtcbiAgICAgIGxldCBkaXN0ID0gZGlzdGFuY2UodmVydGV4MSwgdmVydGV4Mik7XG5cbiAgICAgIGlmIChkaXN0IDwgbWluRGlzdClcbiAgICAgICAgZWRnZXMucHVzaChuZXcgRWRnZSh2ZXJ0ZXgxLCB2ZXJ0ZXgyLCBkaXN0LCBtaW5EaXN0KSk7XG4gICAgfVxuICB9XG5cbiAgZWxhcHNlZFRpbWUgKz0gZHQ7XG59XG5cbmZ1bmN0aW9uIHJlbmRlcihkdCkge1xuICBjdHguY2xlYXJSZWN0KDAsIDAsIGNhbnZhc1dpZHRoLCBjYW52YXNIZWlnaHQpO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGljZXMubGVuZ3RoOyBpKyspXG4gICAgdmVydGljZXNbaV0uZHJhdyhjdHgsIGR0KTtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGVkZ2VzLmxlbmd0aDsgaSsrKVxuICAgIGVkZ2VzW2ldLmRyYXcoY3R4LCBkdCk7XG59XG5cbmZ1bmN0aW9uIHN0YXJ0KCkge1xuICB3aW5kb3dXaWR0aCA9IHBhcnNlSW50KHdpbmRvdy5pbm5lcldpZHRoLCAxMCk7XG4gIHdpbmRvd0hlaWdodCA9IHBhcnNlSW50KHdpbmRvdy5pbm5lckhlaWdodCwgMTApO1xuXG4gIGNhbnZhcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNzY2VuZScpO1xuICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcblxuICB1cGRhdGVDYW52YXNTaXplKClcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHVwZGF0ZUNhbnZhc1NpemUpO1xuXG4gIGxvb3AucnVuKG9wdGlvbnMpO1xufVxuXG4vLyBBbmltYXRpb25cbnZhciBtaW5EaXN0ID0gMjAwMDA7IC8vIHNxdWFyZSBkaXN0YW5jZVxudmFyIHZlcnRpY2VzTnVtO1xudmFyIHZlcnRpY2VzID0gW107XG5cbnZhciBQSVhFTF9SQVRJTyA9IChmdW5jdGlvbigpIHtcbiAgdmFyIGNvbnRleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiY2FudmFzXCIpLmdldENvbnRleHQoXCIyZFwiKSxcbiAgICBkcHIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxLFxuICAgIGJzciA9IGNvbnRleHQud2Via2l0QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fFxuICAgIGNvbnRleHQubW96QmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fFxuICAgIGNvbnRleHQubXNCYWNraW5nU3RvcmVQaXhlbFJhdGlvIHx8XG4gICAgY29udGV4dC5vQmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fFxuICAgIGNvbnRleHQuYmFja2luZ1N0b3JlUGl4ZWxSYXRpbyB8fCAxO1xuXG4gIHJldHVybiBkcHIgLyBic3I7XG59KSgpO1xuXG5mdW5jdGlvbiB1cGRhdGVDYW52YXNTaXplKCkge1xuICB3aW5kb3dXaWR0aCA9IHBhcnNlSW50KHdpbmRvdy5pbm5lcldpZHRoLCAxMCk7XG4gIHdpbmRvd0hlaWdodCA9IHBhcnNlSW50KHdpbmRvdy5pbm5lckhlaWdodCwgMTApO1xuICBjYW52YXNXaWR0aCA9IHdpbmRvd1dpZHRoICogUElYRUxfUkFUSU87XG4gIGNhbnZhc0hlaWdodCA9IHdpbmRvd0hlaWdodCAqIFBJWEVMX1JBVElPO1xuXG4gIGNhbnZhcy53aWR0aCA9IGNhbnZhc1dpZHRoO1xuICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzSGVpZ2h0O1xuICBjYW52YXMuc3R5bGUud2lkdGggPSB3aW5kb3dXaWR0aCArIFwicHhcIjtcbiAgY2FudmFzLnN0eWxlLmhlaWdodCA9IHdpbmRvd0hlaWdodCArIFwicHhcIjtcbiAgY2FudmFzLmdldENvbnRleHQoXCIyZFwiKS5zZXRUcmFuc2Zvcm0oUElYRUxfUkFUSU8sIDAsIDAsIFBJWEVMX1JBVElPLCAwLCAwKTtcblxuICB2ZXJ0aWNlcyA9IFtdO1xuICB2ZXJ0aWNlc051bSA9IE1hdGgucm91bmQoY2FudmFzV2lkdGggKiBjYW52YXNIZWlnaHQgLyAxMjAwMCk7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJ0aWNlc051bTsgaSsrKSB7XG4gICAgdmVydGljZXMucHVzaChuZXcgVmVydGV4KHtcbiAgICAgIGNhbnZhc01hcmdpbjogMC4xLFxuICAgICAgdmVsb2NpdHlGYWN0b3I6IDcsXG4gICAgICBtaW5SYWRpdXM6IDQsXG4gICAgICByYWRpdXNWYXJpYW5jZTogNixcbiAgICAgIG1pbkZhZGVpbkR1cmF0aW9uOiAzLFxuICAgICAgZmFkZWluRHVyYXRpb25WYXJpYW5jZTogMlxuICAgIH0pKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBkaXN0YW5jZSh2ZXJ0ZXgxLCB2ZXJ0ZXgyKSB7XG4gIGxldCBkeCA9IHZlcnRleDEuY29vcmRpbmF0ZXMueCAtIHZlcnRleDIuY29vcmRpbmF0ZXMueDtcbiAgbGV0IGR5ID0gdmVydGV4MS5jb29yZGluYXRlcy55IC0gdmVydGV4Mi5jb29yZGluYXRlcy55O1xuXG4gIHJldHVybiBkeCAqIGR4ICsgZHkgKiBkeTtcbn1cblxuZnVuY3Rpb24gZHJhd0VkZ2UodmVydGV4MSwgdmVydGV4MiwgZGlzdCkge1xuICBjdHguYmVnaW5QYXRoKCk7XG4gIGN0eC5zdHJva2VTdHlsZSA9IFwicmdiYSgwLCAwLCAwLCBcIiArICgxLjIgLSBkaXN0IC8gbWluRGlzdCkgKiBNYXRoLm1heCh2ZXJ0ZXgxLm9wYWNpdHksIHZlcnRleDIub3BhY2l0eSkgKyBcIilcIjtcbiAgY3R4Lm1vdmVUbyh2ZXJ0ZXgxLmNvb3JkaW5hdGVzLngsIHZlcnRleDEuY29vcmRpbmF0ZXMueSk7XG4gIGN0eC5saW5lVG8odmVydGV4Mi5jb29yZGluYXRlcy54LCB2ZXJ0ZXgyLmNvb3JkaW5hdGVzLnkpO1xuICBjdHguc3Ryb2tlKCk7XG4gIGN0eC5jbG9zZVBhdGgoKTtcbn1cblxuZnVuY3Rpb24gb25PcmllbnRhdGlvbihiZXRhLCBnYW1tYSkge1xuICBsZXQgbm93ID0gdGltZXN0YW1wKCk7XG4gIGxldCBrID0gMC44O1xuXG4gIGlmIChwcmV2aW91c1RpbWVzdGFtcCAmJiBwcmV2aW91c0JldGEgJiYgcHJldmlvdXNHYW1tYSnCoCB7XG4gICAgbGV0IGR0ID0gbm93IC0gcHJldmlvdXNUaW1lc3RhbXA7XG4gICAgZEJldGEgPSAoYmV0YSAtIHByZXZpb3VzQmV0YSkgLyBkdDtcbiAgICBkR2FtbWEgPSAoZ2FtbWEgLSBwcmV2aW91c0dhbW1hKSAvIGR0O1xuICB9XG5cbiAgcHJldmlvdXNUaW1lc3RhbXAgPSBub3c7XG4gIHByZXZpb3VzQmV0YSA9IGJldGE7XG4gIHByZXZpb3VzR2FtbWEgPSBnYW1tYTtcblxuICBpZiAoZEJldGEgJiYgZEdhbW1hKSB7XG4gICAgaWYgKHByZXZpb3VzREJldGFGaWx0ZXJlZCAmJiBwcmV2aW91c0RHYW1tYUZpbHRlcmVkKSB7XG4gICAgICBkQmV0YUZpbHRlcmVkID0gayAqIHByZXZpb3VzREJldGFGaWx0ZXJlZCArICgxIC0gaykgKiBkQmV0YTtcbiAgICAgIGRHYW1tYUZpbHRlcmVkID0gayAqIHByZXZpb3VzREdhbW1hRmlsdGVyZWQgKyAoMSAtIGspICogZEdhbW1hO1xuICAgIH0gZWxzZSB7XG4gICAgICBkQmV0YUZpbHRlcmVkID0gZEJldGE7XG4gICAgICBkR2FtbWFGaWx0ZXJlZCA9IGRHYW1tYTtcbiAgICB9XG5cbiAgICBwcmV2aW91c0RCZXRhRmlsdGVyZWQgPSBkQmV0YUZpbHRlcmVkO1xuICAgIHByZXZpb3VzREdhbW1hRmlsdGVyZWQgPSBkR2FtbWFGaWx0ZXJlZDtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGljZXMubGVuZ3RoOyBpKyspXG4gICAgICB2ZXJ0aWNlc1tpXS5vbk9yaWVudGF0aW9uKGRCZXRhRmlsdGVyZWQsIGRHYW1tYUZpbHRlcmVkKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB0aW1lc3RhbXAoKSB7XG4gIHJldHVybiB3aW5kb3cucGVyZm9ybWFuY2UgJiYgd2luZG93LnBlcmZvcm1hbmNlLm5vdyA/IHdpbmRvdy5wZXJmb3JtYW5jZS5ub3coKSA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xufVxuXG52YXIgcHJldmlvdXNUaW1lc3RhbXA7XG52YXIgcHJldmlvdXNCZXRhO1xudmFyIHByZXZpb3VzR2FtbWE7XG52YXIgZEJldGE7XG52YXIgZEdhbW1hO1xudmFyIGRCZXRhRmlsdGVyZWQ7XG52YXIgZEdhbW1hRmlsdGVyZWQ7XG52YXIgcHJldmlvdXNEQmV0YUZpbHRlcmVkO1xudmFyIHByZXZpb3VzREdhbW1hRmlsdGVyZWQ7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBzdGFydDogc3RhcnQsXG4gIG9uT3JpZW50YXRpb246IG9uT3JpZW50YXRpb25cbn07XG4iXX0=