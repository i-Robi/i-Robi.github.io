// http://codeincomplete.com/posts/2013/12/4/javascript_game_foundations_the_game_loop/
"use strict";

function timestamp() {
  return window.performance && window.performance.now ? window.performance.now() : new Date().getTime();
}

var loop = {
  run: function run(options) {

    var now;
    var dt = 0;
    var last = timestamp();
    var step = 1 / options.fps;
    var ctx = options.ctx;
    var buffers = options.buffers;
    var update = options.update;
    var render = options.render;
    var gui = options.gui;

    (function (that) {
      function loop() {
        var slow = gui && gui.slow ? gui.slow : 1; // slow motion scaling factor
        var slowStep = slow * step;

        now = timestamp();
        dt = dt + Math.min(1, (now - last) / 1000);

        while (dt > slowStep) {
          dt = dt - slowStep;
          update(step);
        }

        render(ctx, buffers, dt / slow);

        last = now;
        that.rAFid = requestAnimationFrame(loop);
      }

      that.rAFid = requestAnimationFrame(loop);
    })(this);
  },

  quit: function quit() {
    cancelAnimationFrame(this.rAFid);
  }
};

module.exports = exports = loop;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9sb29wLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLFNBQVMsU0FBUyxHQUFHO0FBQ25CLFNBQU8sTUFBTSxDQUFDLFdBQVcsSUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7Q0FDdkc7O0FBRUQsSUFBSSxJQUFJLEdBQUc7QUFDVCxLQUFHLEVBQUUsYUFBUyxPQUFPLEVBQUU7O0FBRXJCLFFBQUksR0FBRyxDQUFDO0FBQ1IsUUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ1gsUUFBSSxJQUFJLEdBQUcsU0FBUyxFQUFFLENBQUM7QUFDdkIsUUFBSSxJQUFJLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUFDM0IsUUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztBQUN0QixRQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO0FBQzlCLFFBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDNUIsUUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUM1QixRQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDOztBQUV0QixBQUFDLEtBQUEsVUFBUyxJQUFJLEVBQUU7QUFDZCxlQUFTLElBQUksR0FBRztBQUNkLFlBQUksSUFBSSxHQUFPLEFBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEdBQUksR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7QUFDaEQsWUFBSSxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQzs7QUFFM0IsV0FBRyxHQUFHLFNBQVMsRUFBRSxDQUFDO0FBQ2xCLFVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFBLEdBQUksSUFBSSxDQUFDLENBQUM7O0FBRTNDLGVBQU0sRUFBRSxHQUFHLFFBQVEsRUFBRTtBQUNqQixZQUFFLEdBQUcsRUFBRSxHQUFHLFFBQVEsQ0FBQztBQUNuQixnQkFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2hCOztBQUVELGNBQU0sQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUUsR0FBQyxJQUFJLENBQUMsQ0FBQzs7QUFFOUIsWUFBSSxHQUFHLEdBQUcsQ0FBQztBQUNYLFlBQUksQ0FBQyxLQUFLLEdBQUcscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7T0FDMUM7O0FBRUQsVUFBSSxDQUFDLEtBQUssR0FBRyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUMxQyxDQUFBLENBQUMsSUFBSSxDQUFDLENBQUU7R0FDVjs7QUFFRCxNQUFJLEVBQUUsZ0JBQVc7QUFDZix3QkFBb0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7R0FDbEM7Q0FDRixDQUFDOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQyIsImZpbGUiOiJzcmMvbG9vcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGh0dHA6Ly9jb2RlaW5jb21wbGV0ZS5jb20vcG9zdHMvMjAxMy8xMi80L2phdmFzY3JpcHRfZ2FtZV9mb3VuZGF0aW9uc190aGVfZ2FtZV9sb29wL1xuZnVuY3Rpb24gdGltZXN0YW1wKCkge1xuICByZXR1cm4gd2luZG93LnBlcmZvcm1hbmNlICYmIHdpbmRvdy5wZXJmb3JtYW5jZS5ub3cgPyB3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbn1cblxudmFyIGxvb3AgPSB7XG4gIHJ1bjogZnVuY3Rpb24ob3B0aW9ucykge1xuXG4gICAgdmFyIG5vdztcbiAgICB2YXIgZHQgPSAwO1xuICAgIHZhciBsYXN0ID0gdGltZXN0YW1wKCk7XG4gICAgdmFyIHN0ZXAgPSAxIC8gb3B0aW9ucy5mcHM7XG4gICAgdmFyIGN0eCA9IG9wdGlvbnMuY3R4O1xuICAgIHZhciBidWZmZXJzID0gb3B0aW9ucy5idWZmZXJzO1xuICAgIHZhciB1cGRhdGUgPSBvcHRpb25zLnVwZGF0ZTtcbiAgICB2YXIgcmVuZGVyID0gb3B0aW9ucy5yZW5kZXI7XG4gICAgdmFyIGd1aSA9IG9wdGlvbnMuZ3VpO1xuXG4gICAgKGZ1bmN0aW9uKHRoYXQpIHtcbiAgICAgIGZ1bmN0aW9uIGxvb3AoKSB7XG4gICAgICAgIHZhciBzbG93ICAgICA9IChndWkgJiYgZ3VpLnNsb3cpID8gZ3VpLnNsb3cgOiAxOyAvLyBzbG93IG1vdGlvbiBzY2FsaW5nIGZhY3RvclxuICAgICAgICB2YXIgc2xvd1N0ZXAgPSBzbG93ICogc3RlcDtcblxuICAgICAgICBub3cgPSB0aW1lc3RhbXAoKTtcbiAgICAgICAgZHQgPSBkdCArIE1hdGgubWluKDEsIChub3cgLSBsYXN0KSAvIDEwMDApO1xuXG4gICAgICAgIHdoaWxlKGR0ID4gc2xvd1N0ZXApIHtcbiAgICAgICAgICAgIGR0ID0gZHQgLSBzbG93U3RlcDtcbiAgICAgICAgICAgIHVwZGF0ZShzdGVwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlbmRlcihjdHgsIGJ1ZmZlcnMsIGR0L3Nsb3cpO1xuXG4gICAgICAgIGxhc3QgPSBub3c7XG4gICAgICAgIHRoYXQuckFGaWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7XG4gICAgICB9XG5cbiAgICAgIHRoYXQuckFGaWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7XG4gICAgfSh0aGlzKSk7XG4gIH0sXG5cbiAgcXVpdDogZnVuY3Rpb24oKSB7XG4gICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5yQUZpZCk7XG4gIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IGxvb3A7Il19